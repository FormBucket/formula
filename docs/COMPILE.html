<!DOCTYPE html>

<html>
<head>
  <title>COMPILE.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ABS.html">
                  ABS.js
                </a>
              
                
                <a class="source" href="ACOS.html">
                  ACOS.js
                </a>
              
                
                <a class="source" href="ADD.html">
                  ADD.js
                </a>
              
                
                <a class="source" href="ADDRESS.html">
                  ADDRESS.js
                </a>
              
                
                <a class="source" href="AND.html">
                  AND.js
                </a>
              
                
                <a class="source" href="AVERAGE.html">
                  AVERAGE.js
                </a>
              
                
                <a class="source" href="BIN2DEC.html">
                  BIN2DEC.js
                </a>
              
                
                <a class="source" href="CELLINDEX.html">
                  CELLINDEX.js
                </a>
              
                
                <a class="source" href="CHANGED.html">
                  CHANGED.js
                </a>
              
                
                <a class="source" href="CHAR.html">
                  CHAR.js
                </a>
              
                
                <a class="source" href="CHOOSE.html">
                  CHOOSE.js
                </a>
              
                
                <a class="source" href="CLEAN.html">
                  CLEAN.js
                </a>
              
                
                <a class="source" href="CODE.html">
                  CODE.js
                </a>
              
                
                <a class="source" href="COLUMN.html">
                  COLUMN.js
                </a>
              
                
                <a class="source" href="COLUMNLETTER.html">
                  COLUMNLETTER.js
                </a>
              
                
                <a class="source" href="COLUMNNUMBER.html">
                  COLUMNNUMBER.js
                </a>
              
                
                <a class="source" href="COMPILE.html">
                  COMPILE.js
                </a>
              
                
                <a class="source" href="CONCATENATE.html">
                  CONCATENATE.js
                </a>
              
                
                <a class="source" href="COND.html">
                  COND.js
                </a>
              
                
                <a class="source" href="CONSTANTS.html">
                  CONSTANTS.js
                </a>
              
                
                <a class="source" href="COS.html">
                  COS.js
                </a>
              
                
                <a class="source" href="DATE.html">
                  DATE.js
                </a>
              
                
                <a class="source" href="DATEDIF.html">
                  DATEDIF.js
                </a>
              
                
                <a class="source" href="DATEVALUE.html">
                  DATEVALUE.js
                </a>
              
                
                <a class="source" href="DAYS360.html">
                  DAYS360.js
                </a>
              
                
                <a class="source" href="DEC2BIN.html">
                  DEC2BIN.js
                </a>
              
                
                <a class="source" href="DIFF.html">
                  DIFF.js
                </a>
              
                
                <a class="source" href="DIVIDE.html">
                  DIVIDE.js
                </a>
              
                
                <a class="source" href="EQ.html">
                  EQ.js
                </a>
              
                
                <a class="source" href="ERROR.html">
                  ERROR.js
                </a>
              
                
                <a class="source" href="EXACT.html">
                  EXACT.js
                </a>
              
                
                <a class="source" href="FILTER.html">
                  FILTER.js
                </a>
              
                
                <a class="source" href="FIND.html">
                  FIND.js
                </a>
              
                
                <a class="source" href="FLATTEN.html">
                  FLATTEN.js
                </a>
              
                
                <a class="source" href="GT.html">
                  GT.js
                </a>
              
                
                <a class="source" href="GTE.html">
                  GTE.js
                </a>
              
                
                <a class="source" href="GUID.html">
                  GUID.js
                </a>
              
                
                <a class="source" href="HLOOKUP.html">
                  HLOOKUP.js
                </a>
              
                
                <a class="source" href="IF.html">
                  IF.js
                </a>
              
                
                <a class="source" href="IFBLANK.html">
                  IFBLANK.js
                </a>
              
                
                <a class="source" href="IFEMPTY.html">
                  IFEMPTY.js
                </a>
              
                
                <a class="source" href="IFERROR.html">
                  IFERROR.js
                </a>
              
                
                <a class="source" href="IFNA.html">
                  IFNA.js
                </a>
              
                
                <a class="source" href="IN.html">
                  IN.js
                </a>
              
                
                <a class="source" href="INDEX2COL.html">
                  INDEX2COL.js
                </a>
              
                
                <a class="source" href="INDEX2ROW.html">
                  INDEX2ROW.js
                </a>
              
                
                <a class="source" href="INDIRECT.html">
                  INDIRECT.js
                </a>
              
                
                <a class="source" href="ISARRAY.html">
                  ISARRAY.js
                </a>
              
                
                <a class="source" href="ISBINARY.html">
                  ISBINARY.js
                </a>
              
                
                <a class="source" href="ISBLANK.html">
                  ISBLANK.js
                </a>
              
                
                <a class="source" href="ISDATE.html">
                  ISDATE.js
                </a>
              
                
                <a class="source" href="ISEMAIL.html">
                  ISEMAIL.js
                </a>
              
                
                <a class="source" href="ISEMPTY.html">
                  ISEMPTY.js
                </a>
              
                
                <a class="source" href="ISERR.html">
                  ISERR.js
                </a>
              
                
                <a class="source" href="ISERROR.html">
                  ISERROR.js
                </a>
              
                
                <a class="source" href="ISEVEN.html">
                  ISEVEN.js
                </a>
              
                
                <a class="source" href="ISFUNCTION.html">
                  ISFUNCTION.js
                </a>
              
                
                <a class="source" href="ISNA.html">
                  ISNA.js
                </a>
              
                
                <a class="source" href="ISNUMBER.html">
                  ISNUMBER.js
                </a>
              
                
                <a class="source" href="ISODD.html">
                  ISODD.js
                </a>
              
                
                <a class="source" href="ISREF.html">
                  ISREF.js
                </a>
              
                
                <a class="source" href="ISTEXT.html">
                  ISTEXT.js
                </a>
              
                
                <a class="source" href="ISURL.html">
                  ISURL.js
                </a>
              
                
                <a class="source" href="LEN.html">
                  LEN.js
                </a>
              
                
                <a class="source" href="LOOKUP.html">
                  LOOKUP.js
                </a>
              
                
                <a class="source" href="LOWER.html">
                  LOWER.js
                </a>
              
                
                <a class="source" href="LT.html">
                  LT.js
                </a>
              
                
                <a class="source" href="LTE.html">
                  LTE.js
                </a>
              
                
                <a class="source" href="MATCH.html">
                  MATCH.js
                </a>
              
                
                <a class="source" href="MAX.html">
                  MAX.js
                </a>
              
                
                <a class="source" href="MERGE.html">
                  MERGE.js
                </a>
              
                
                <a class="source" href="MIN.html">
                  MIN.js
                </a>
              
                
                <a class="source" href="MULTIPLY.html">
                  MULTIPLY.js
                </a>
              
                
                <a class="source" href="N.html">
                  N.js
                </a>
              
                
                <a class="source" href="NE.html">
                  NE.js
                </a>
              
                
                <a class="source" href="NOT.html">
                  NOT.js
                </a>
              
                
                <a class="source" href="OCT2DEC.html">
                  OCT2DEC.js
                </a>
              
                
                <a class="source" href="OR.html">
                  OR.js
                </a>
              
                
                <a class="source" href="PARSEBOOL.html">
                  PARSEBOOL.js
                </a>
              
                
                <a class="source" href="PARSEDATE.html">
                  PARSEDATE.js
                </a>
              
                
                <a class="source" href="PI.html">
                  PI.js
                </a>
              
                
                <a class="source" href="PMT.html">
                  PMT.js
                </a>
              
                
                <a class="source" href="POWER.html">
                  POWER.js
                </a>
              
                
                <a class="source" href="PROPER.html">
                  PROPER.js
                </a>
              
                
                <a class="source" href="REF.html">
                  REF.js
                </a>
              
                
                <a class="source" href="REPLACE.html">
                  REPLACE.js
                </a>
              
                
                <a class="source" href="REPT.html">
                  REPT.js
                </a>
              
                
                <a class="source" href="RIGHT.html">
                  RIGHT.js
                </a>
              
                
                <a class="source" href="ROUND.html">
                  ROUND.js
                </a>
              
                
                <a class="source" href="ROUNDUP.html">
                  ROUNDUP.js
                </a>
              
                
                <a class="source" href="RUN.html">
                  RUN.js
                </a>
              
                
                <a class="source" href="SEARCH.html">
                  SEARCH.js
                </a>
              
                
                <a class="source" href="SELECT.html">
                  SELECT.js
                </a>
              
                
                <a class="source" href="SERIAL.html">
                  SERIAL.js
                </a>
              
                
                <a class="source" href="SIN.html">
                  SIN.js
                </a>
              
                
                <a class="source" href="SORT.html">
                  SORT.js
                </a>
              
                
                <a class="source" href="SPLIT.html">
                  SPLIT.js
                </a>
              
                
                <a class="source" href="SUBSTITUTE.html">
                  SUBSTITUTE.js
                </a>
              
                
                <a class="source" href="SUBTRACT.html">
                  SUBTRACT.js
                </a>
              
                
                <a class="source" href="SUM.html">
                  SUM.js
                </a>
              
                
                <a class="source" href="SWITCH.html">
                  SWITCH.js
                </a>
              
                
                <a class="source" href="TAN.html">
                  TAN.js
                </a>
              
                
                <a class="source" href="TAU.html">
                  TAU.js
                </a>
              
                
                <a class="source" href="TEXT.html">
                  TEXT.js
                </a>
              
                
                <a class="source" href="TRIM.html">
                  TRIM.js
                </a>
              
                
                <a class="source" href="UNIQUE.html">
                  UNIQUE.js
                </a>
              
                
                <a class="source" href="UPPER.html">
                  UPPER.js
                </a>
              
                
                <a class="source" href="VLOOKUP.html">
                  VLOOKUP.js
                </a>
              
                
                <a class="source" href="XOR.html">
                  XOR.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>COMPILE.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015 Peter W Moresi</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> {parser} <span class="hljs-keyword">from</span> <span class="hljs-string">'../lib/PARSER'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> Box <span class="hljs-keyword">from</span> <span class="hljs-string">'./index'</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapString</span>(<span class="hljs-params">s</span>) </span>{
  <span class="hljs-keyword">if</span> (s[<span class="hljs-number">0</span>] == <span class="hljs-string">"'"</span> &amp;&amp; s[s.length<span class="hljs-number">-1</span>] === <span class="hljs-string">"'"</span>) {
    <span class="hljs-keyword">return</span> s;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">'\''</span> + s + <span class="hljs-string">'\''</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printItems</span>(<span class="hljs-params">items</span>) </span>{
  <span class="hljs-keyword">return</span> items.map(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">n</span>)</span>{
    <span class="hljs-keyword">return</span> compiler( n );
  }).join(<span class="hljs-string">', '</span>)
}

<span class="hljs-keyword">var</span> compiledNumber = <span class="hljs-number">0</span>;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">COMPILE</span>(<span class="hljs-params">exp</span>) </span>{
  <span class="hljs-keyword">var</span> ast = exp,
      jsCode,
      functionCode,
      f,
      suppress = <span class="hljs-literal">false</span>,
      precedents = [],
      requires = [],
      namespace=<span class="hljs-string">'this.'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>convert to AST when string provided</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> ast === <span class="hljs-string">'string'</span>) {
    ast = parser.parse(exp);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>define a compiler function to handle recurse the AST.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compiler</span>(<span class="hljs-params"> node </span>) </span>{

    <span class="hljs-keyword">let</span> lhs, rhs;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The node is expected to be either an operator, function or a value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">switch</span>(node.type) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'operator'</span>:
        <span class="hljs-keyword">switch</span>(node.subtype) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'prefix-plus'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'+'</span> + compiler( node.operands[<span class="hljs-number">0</span>] );
          <span class="hljs-keyword">case</span> <span class="hljs-string">'prefix-minus'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'-'</span> + compiler( node.operands[<span class="hljs-number">0</span>] );
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-add'</span>:
            requires.push(<span class="hljs-string">'add'</span>);
            <span class="hljs-keyword">return</span> namespace + <span class="hljs-string">"ADD("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                   compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-subtract'</span>:
            requires.push(<span class="hljs-string">'subtract'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"SUBTRACT("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-multiply'</span>:
            requires.push(<span class="hljs-string">'multiply'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"MULTIPLY("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-divide'</span>:
            requires.push(<span class="hljs-string">'divide'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"DIVIDE("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-power'</span>:
            requires.push(<span class="hljs-string">'power'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">'POWER('</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span>
                  + compiler( node.operands[<span class="hljs-number">1</span>] ) + <span class="hljs-string">')'</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-concat'</span>:
            lhs = compiler( node.operands[<span class="hljs-number">0</span>] );
            rhs = compiler( node.operands[<span class="hljs-number">1</span>] );
            requires.push(<span class="hljs-string">'concatenate'</span>);
            <span class="hljs-keyword">return</span> namespace + <span class="hljs-string">"CONCATENATE("</span> + wrapString(lhs) + <span class="hljs-string">', '</span> + wrapString(rhs) + <span class="hljs-string">")"</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-eq'</span>:
            requires.push(<span class="hljs-string">'eq'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"EQ("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-ne'</span>:
            requires.push(<span class="hljs-string">'ne'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"NE("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-gt'</span>:
            requires.push(<span class="hljs-string">'gt'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"GT("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-gte'</span>:
            requires.push(<span class="hljs-string">'gte'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"GTE("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-lt'</span>:
            requires.push(<span class="hljs-string">'lt'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"LT("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'infix-lte'</span>:
            requires.push(<span class="hljs-string">'lte'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">"LTE("</span> + compiler( node.operands[<span class="hljs-number">0</span>] ) + <span class="hljs-string">', '</span> +
                    compiler( node.operands[<span class="hljs-number">1</span>]) + <span class="hljs-string">")"</span>);
        }
        <span class="hljs-keyword">throw</span> TypeException(<span class="hljs-string">"Unknown operator: "</span> + node.subtype);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'group'</span>:
        <span class="hljs-keyword">return</span> (<span class="hljs-string">'('</span> +  compiler( node.exp ) + <span class="hljs-string">')'</span>);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'function'</span>:
        <span class="hljs-keyword">switch</span> (node.name.toUpperCase()) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'IF'</span>:
            requires.push(<span class="hljs-string">'if'</span>);
            <span class="hljs-keyword">if</span> ( node.args.length &gt; <span class="hljs-number">3</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"IF sent too many arguments."</span>); }
            <span class="hljs-keyword">if</span> ( node.args.length !== <span class="hljs-number">3</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"IF expects 3 arguments"</span>); }
            <span class="hljs-keyword">return</span> (<span class="hljs-string">'(('</span> + compiler( node.args[<span class="hljs-number">0</span>] ) +
                    <span class="hljs-string">') ?'</span> + compiler( node.args[<span class="hljs-number">1</span>] ) +
                    <span class="hljs-string">' : '</span> + compiler( node.args[<span class="hljs-number">2</span>] ) + <span class="hljs-string">')'</span>);

          <span class="hljs-keyword">case</span> <span class="hljs-string">'NOT'</span>:
            requires.push(<span class="hljs-string">'not'</span>);
            <span class="hljs-keyword">if</span> ( node.args.length !== <span class="hljs-number">1</span>) { <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"NOT only accepts one argument"</span>); }
            <span class="hljs-keyword">return</span> namespace + <span class="hljs-string">"NOT(' + compiler( node.args[0] ) + ')"</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'AND'</span>:
            requires.push(<span class="hljs-string">'and'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">'AND('</span> +
                    printItems(node.args) + <span class="hljs-string">')'</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'OR'</span>:
            requires.push(<span class="hljs-string">'or'</span>);
            <span class="hljs-keyword">return</span> (namespace + <span class="hljs-string">'OR('</span> +
                    printItems(node.args) + <span class="hljs-string">')'</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'ABS'</span>:
            requires.push(<span class="hljs-string">'abs'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">'ABS('</span> + compiler(node) + <span class="hljs-string">')'</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'MIN'</span>:
            requires.push(<span class="hljs-string">'min'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Math.min('</span> +  printItems(node.args) + <span class="hljs-string">')'</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'MAX'</span>:
            requires.push(<span class="hljs-string">'max'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Math.max('</span> + printItems(node.args) + <span class="hljs-string">')'</span>;
          <span class="hljs-keyword">default</span>:
            requires.push(name);
            <span class="hljs-keyword">return</span> (namespace + node.name + <span class="hljs-string">'( '</span> + printItems(node.args) + <span class="hljs-string">' )'</span>);

        }
      <span class="hljs-keyword">case</span> <span class="hljs-string">'cell'</span>:
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> precedents !== <span class="hljs-string">"undefined"</span> &amp;&amp; !suppress) { precedents.push(node); }

        <span class="hljs-keyword">return</span> <span class="hljs-string">'context.get(\"'</span> + node.addr + <span class="hljs-string">'\")'</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">'range'</span>:

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> precedents !== <span class="hljs-string">"undefined"</span>) { precedents.push(node); suppress = <span class="hljs-literal">true</span>; }
        lhs = compiler(node.topLeft);
        rhs = compiler(node.bottomRight);
        suppress = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>anonymous functions are the perfect solution for dynamic ranges but was not immediately obvious to me</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> ( node.topLeft.type === <span class="hljs-string">"function"</span> ) {
          lhs = <span class="hljs-string">"function() { return ("</span> + lhs + <span class="hljs-string">"); }"</span>
        }

        <span class="hljs-keyword">if</span> ( node.bottomRight.type === <span class="hljs-string">"function"</span> ) {
          rhs = <span class="hljs-string">"function() { return ("</span> + rhs + <span class="hljs-string">"); }"</span>
        }

        <span class="hljs-keyword">return</span> (<span class="hljs-string">'context.range( '</span> + lhs + <span class="hljs-string">', '</span> + rhs + <span class="hljs-string">' )'</span> );

      <span class="hljs-keyword">case</span> <span class="hljs-string">'value'</span>:
        <span class="hljs-keyword">switch</span> (node.subtype) {
          <span class="hljs-keyword">case</span> <span class="hljs-string">'array'</span>:
            <span class="hljs-keyword">return</span> (<span class="hljs-string">'['</span> + printItems(node.items) + <span class="hljs-string">']'</span>);
          <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"'"</span> + node.value.replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">"''"</span>) + <span class="hljs-string">"'"</span>;
          <span class="hljs-keyword">case</span> <span class="hljs-string">'variable'</span>:

            <span class="hljs-keyword">if</span> (precedents &amp;&amp; !suppress) { precedents.push(node); }

            <span class="hljs-keyword">return</span> <span class="hljs-string">'context.get(\"'</span> + node.value + <span class="hljs-string">'\")'</span>;

          <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> node.value;
        }
    }
  }

  <span class="hljs-keyword">var</span> id = compiledNumber++;

  <span class="hljs-keyword">var</span> compiled = compiler(ast);

  f = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">'context'</span>, <span class="hljs-string">`// <span class="hljs-subst">${exp}</span>
  return (<span class="hljs-subst">${compiled}</span>);
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>@ sourceURL=formula<em>function</em>${id}.js’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-string">`);

  f.id = id;
  f.exp = exp;
  f.ast = ast;
  f.code = compiled;
  f.precedents = precedents;
  f.requires = requires
    .map(n =&gt; n.toUpperCase())
    .reduce( function(out, name) {
      out[name] = Box[name];
      return out;
    }, {} );
  f.run = f.bind(f.requires)

  return f

}

</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
