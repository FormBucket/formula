<!DOCTYPE html>

<html>
<head>
  <title>text.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="abs.html">
                  abs.js
                </a>
              
                
                <a class="source" href="acos.html">
                  acos.js
                </a>
              
                
                <a class="source" href="add.html">
                  add.js
                </a>
              
                
                <a class="source" href="address.html">
                  address.js
                </a>
              
                
                <a class="source" href="and.html">
                  and.js
                </a>
              
                
                <a class="source" href="average.html">
                  average.js
                </a>
              
                
                <a class="source" href="bin2dec.html">
                  bin2dec.js
                </a>
              
                
                <a class="source" href="branch.html">
                  branch.js
                </a>
              
                
                <a class="source" href="cellindex.html">
                  cellindex.js
                </a>
              
                
                <a class="source" href="changed.html">
                  changed.js
                </a>
              
                
                <a class="source" href="char.html">
                  char.js
                </a>
              
                
                <a class="source" href="choose.html">
                  choose.js
                </a>
              
                
                <a class="source" href="clean.html">
                  clean.js
                </a>
              
                
                <a class="source" href="code.html">
                  code.js
                </a>
              
                
                <a class="source" href="column.html">
                  column.js
                </a>
              
                
                <a class="source" href="columnletter.html">
                  columnletter.js
                </a>
              
                
                <a class="source" href="columnnumber.html">
                  columnnumber.js
                </a>
              
                
                <a class="source" href="concatenate.html">
                  concatenate.js
                </a>
              
                
                <a class="source" href="constants.html">
                  constants.js
                </a>
              
                
                <a class="source" href="cos.html">
                  cos.js
                </a>
              
                
                <a class="source" href="date.html">
                  date.js
                </a>
              
                
                <a class="source" href="datedif.html">
                  datedif.js
                </a>
              
                
                <a class="source" href="datevalue.html">
                  datevalue.js
                </a>
              
                
                <a class="source" href="days360.html">
                  days360.js
                </a>
              
                
                <a class="source" href="dec2bin.html">
                  dec2bin.js
                </a>
              
                
                <a class="source" href="diff.html">
                  diff.js
                </a>
              
                
                <a class="source" href="divide.html">
                  divide.js
                </a>
              
                
                <a class="source" href="eq.html">
                  eq.js
                </a>
              
                
                <a class="source" href="error.html">
                  error.js
                </a>
              
                
                <a class="source" href="exact.html">
                  exact.js
                </a>
              
                
                <a class="source" href="filter.html">
                  filter.js
                </a>
              
                
                <a class="source" href="find.html">
                  find.js
                </a>
              
                
                <a class="source" href="flatten.html">
                  flatten.js
                </a>
              
                
                <a class="source" href="gt.html">
                  gt.js
                </a>
              
                
                <a class="source" href="gte.html">
                  gte.js
                </a>
              
                
                <a class="source" href="guid.html">
                  guid.js
                </a>
              
                
                <a class="source" href="hlookup.html">
                  hlookup.js
                </a>
              
                
                <a class="source" href="ifblank.html">
                  ifblank.js
                </a>
              
                
                <a class="source" href="ifempty.html">
                  ifempty.js
                </a>
              
                
                <a class="source" href="iferror.html">
                  iferror.js
                </a>
              
                
                <a class="source" href="ifna.html">
                  ifna.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
                
                <a class="source" href="index2col.html">
                  index2col.js
                </a>
              
                
                <a class="source" href="index2row.html">
                  index2row.js
                </a>
              
                
                <a class="source" href="indirect.html">
                  indirect.js
                </a>
              
                
                <a class="source" href="isarray.html">
                  isarray.js
                </a>
              
                
                <a class="source" href="isbinary.html">
                  isbinary.js
                </a>
              
                
                <a class="source" href="isblank.html">
                  isblank.js
                </a>
              
                
                <a class="source" href="isdate.html">
                  isdate.js
                </a>
              
                
                <a class="source" href="isemail.html">
                  isemail.js
                </a>
              
                
                <a class="source" href="isempty.html">
                  isempty.js
                </a>
              
                
                <a class="source" href="iserr.html">
                  iserr.js
                </a>
              
                
                <a class="source" href="iserror.html">
                  iserror.js
                </a>
              
                
                <a class="source" href="iseven.html">
                  iseven.js
                </a>
              
                
                <a class="source" href="isfunction.html">
                  isfunction.js
                </a>
              
                
                <a class="source" href="isna.html">
                  isna.js
                </a>
              
                
                <a class="source" href="isnumber.html">
                  isnumber.js
                </a>
              
                
                <a class="source" href="isodd.html">
                  isodd.js
                </a>
              
                
                <a class="source" href="isref.html">
                  isref.js
                </a>
              
                
                <a class="source" href="istext.html">
                  istext.js
                </a>
              
                
                <a class="source" href="isurl.html">
                  isurl.js
                </a>
              
                
                <a class="source" href="len.html">
                  len.js
                </a>
              
                
                <a class="source" href="lookup.html">
                  lookup.js
                </a>
              
                
                <a class="source" href="lower.html">
                  lower.js
                </a>
              
                
                <a class="source" href="lt.html">
                  lt.js
                </a>
              
                
                <a class="source" href="lte.html">
                  lte.js
                </a>
              
                
                <a class="source" href="match.html">
                  match.js
                </a>
              
                
                <a class="source" href="max.html">
                  max.js
                </a>
              
                
                <a class="source" href="merge.html">
                  merge.js
                </a>
              
                
                <a class="source" href="min.html">
                  min.js
                </a>
              
                
                <a class="source" href="multiply.html">
                  multiply.js
                </a>
              
                
                <a class="source" href="n.html">
                  n.js
                </a>
              
                
                <a class="source" href="ne.html">
                  ne.js
                </a>
              
                
                <a class="source" href="not.html">
                  not.js
                </a>
              
                
                <a class="source" href="numbervalue.html">
                  numbervalue.js
                </a>
              
                
                <a class="source" href="oct2dec.html">
                  oct2dec.js
                </a>
              
                
                <a class="source" href="or.html">
                  or.js
                </a>
              
                
                <a class="source" href="parsebool.html">
                  parsebool.js
                </a>
              
                
                <a class="source" href="parsedate.html">
                  parsedate.js
                </a>
              
                
                <a class="source" href="pi.html">
                  pi.js
                </a>
              
                
                <a class="source" href="pmt.html">
                  pmt.js
                </a>
              
                
                <a class="source" href="power.html">
                  power.js
                </a>
              
                
                <a class="source" href="proper.html">
                  proper.js
                </a>
              
                
                <a class="source" href="ref.html">
                  ref.js
                </a>
              
                
                <a class="source" href="replace.html">
                  replace.js
                </a>
              
                
                <a class="source" href="rept.html">
                  rept.js
                </a>
              
                
                <a class="source" href="right.html">
                  right.js
                </a>
              
                
                <a class="source" href="round.html">
                  round.js
                </a>
              
                
                <a class="source" href="roundup.html">
                  roundup.js
                </a>
              
                
                <a class="source" href="search.html">
                  search.js
                </a>
              
                
                <a class="source" href="select.html">
                  select.js
                </a>
              
                
                <a class="source" href="serial.html">
                  serial.js
                </a>
              
                
                <a class="source" href="sin.html">
                  sin.js
                </a>
              
                
                <a class="source" href="some.html">
                  some.js
                </a>
              
                
                <a class="source" href="sort.html">
                  sort.js
                </a>
              
                
                <a class="source" href="split.html">
                  split.js
                </a>
              
                
                <a class="source" href="substitute.html">
                  substitute.js
                </a>
              
                
                <a class="source" href="subtract.html">
                  subtract.js
                </a>
              
                
                <a class="source" href="sum.html">
                  sum.js
                </a>
              
                
                <a class="source" href="tan.html">
                  tan.js
                </a>
              
                
                <a class="source" href="tau.html">
                  tau.js
                </a>
              
                
                <a class="source" href="text.html">
                  text.js
                </a>
              
                
                <a class="source" href="trim.html">
                  trim.js
                </a>
              
                
                <a class="source" href="unique.html">
                  unique.js
                </a>
              
                
                <a class="source" href="upper.html">
                  upper.js
                </a>
              
                
                <a class="source" href="vlookup.html">
                  vlookup.js
                </a>
              
                
                <a class="source" href="xor.html">
                  xor.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>text.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Copyright 2015 Peter W Moresi
based heavily on code from socialcalc</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">import</span> {
  d1900,
  MinutesInHour,
  MinutesInDay,
  SecondsInMinute,
  SecondsInDay,
  SecondsInHour,
  DaysInYear,
  MillisecondsInDay,
  AllowedDays,
  DayNames,
  DayNames3,
  MonthNames,
  MonthNames3,
  AM,
  AM1,
  PM,
  PM1,
  DefaultCurrency,
  SeparatorChar,
  DecimalChar,
  AllowedColors
}
<span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>;

<span class="hljs-keyword">import</span> {parsedate} <span class="hljs-keyword">from</span> <span class="hljs-string">'./parsedate'</span>

<span class="hljs-keyword">let</span> FormatNumber = {};

FormatNumber.format_definitions = {}; <span class="hljs-comment">// Parsed formats are stored here globally</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Other constants</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
FormatNumber.commands = {
  copy: <span class="hljs-number">1</span>, color: <span class="hljs-number">2</span>, integer_placeholder: <span class="hljs-number">3</span>, fraction_placeholder: <span class="hljs-number">4</span>, decimal: <span class="hljs-number">5</span>,
  currency: <span class="hljs-number">6</span>, general:<span class="hljs-number">7</span>, separator: <span class="hljs-number">8</span>, date: <span class="hljs-number">9</span>, comparison: <span class="hljs-number">10</span>, section: <span class="hljs-number">11</span>, style: <span class="hljs-number">12</span>
};


<span class="hljs-comment">/* *******************

result = FormatNumber.formatNumberWithFormat = function(rawvalue, format_string, currency_char)

************************* */</span>

FormatNumber.formatNumberWithFormat = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rawvalue, format_string, currency_char</span>) </span>{

  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> op, operandstr, fromend, cval, operandstrlc;
  <span class="hljs-keyword">var</span> startval, estartval;
  <span class="hljs-keyword">var</span> hrs, mins, secs, ehrs, emins, esecs, ampmstr, ymd;
  <span class="hljs-keyword">var</span> minOK, mpos, mspos;
  <span class="hljs-keyword">var</span> result=<span class="hljs-string">''</span>;
  <span class="hljs-keyword">var</span> format;
  <span class="hljs-keyword">var</span> section, gotcomparison, compop, compval, cpos, oppos;
  <span class="hljs-keyword">var</span> sectioninfo;
  <span class="hljs-keyword">var</span> i, decimalscale, scaledvalue, strvalue, strparts, integervalue, fractionvalue;
  <span class="hljs-keyword">var</span> integerdigits2, integerpos, fractionpos, textcolor, textstyle, separatorchar, decimalchar;
  <span class="hljs-keyword">var</span> value; <span class="hljs-comment">// working copy to change sign, etc.</span>

  rawvalue = rawvalue<span class="hljs-number">-0</span>; <span class="hljs-comment">// make sure a number</span>
  value = rawvalue;
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(value)) <span class="hljs-keyword">return</span> <span class="hljs-string">'NaN'</span>;

  <span class="hljs-keyword">var</span> negativevalue = value &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>; <span class="hljs-comment">// determine sign, etc.</span>
  <span class="hljs-keyword">if</span> (negativevalue) value = -value;
  <span class="hljs-keyword">var</span> zerovalue = value == <span class="hljs-number">0</span> ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;

  currency_char = currency_char || DefaultCurrency;

  FormatNumber.parse_format_string(scfn.format_definitions, format_string); <span class="hljs-comment">// make sure format is parsed</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>console.log(“format_string”, format_string, format)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  format = scfn.format_definitions[format_string]; <span class="hljs-comment">// Get format structure</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>console.log(“format”, format)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span> (!format) <span class="hljs-keyword">throw</span> <span class="hljs-string">'Format not parsed error.'</span>;

  section = format.sectioninfo.length - <span class="hljs-number">1</span>; <span class="hljs-comment">// get number of sections - 1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>has comparisons - determine which section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (format.hascomparison) {
    section = <span class="hljs-number">0</span>; <span class="hljs-comment">// set to which section we will use</span>
    gotcomparison = <span class="hljs-number">0</span>; <span class="hljs-comment">// this section has no comparison</span>
    <span class="hljs-keyword">for</span> (cpos=<span class="hljs-number">0</span>; ;cpos++) { <span class="hljs-comment">// scan for comparisons</span>
      op = format.operators[cpos];
      operandstr = format.operands[cpos]; <span class="hljs-comment">// get next operator and operand</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>at end with no match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!op) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>if comparison but no match</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (gotcomparison) {
          format_string = <span class="hljs-string">'General'</span>; <span class="hljs-comment">// use default of General</span>
          scfn.parse_format_string(scfn.format_definitions, format_string);
          format = scfn.format_definitions[format_string];
          section = <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// if no comparision, matches on this section</span>
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>end of section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (op == scfn.commands.section) {
        <span class="hljs-keyword">if</span> (!gotcomparison) { <span class="hljs-comment">// no comparison, so it's a match</span>
          <span class="hljs-keyword">break</span>;
        }
        gotcomparison = <span class="hljs-number">0</span>;
        section++; <span class="hljs-comment">// check out next one</span>
        <span class="hljs-keyword">continue</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>found a comparison - do we meet it?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (op == scfn.commands.comparison) {
        i=operandstr.indexOf(<span class="hljs-string">':'</span>);
        compop=operandstr.substring(<span class="hljs-number">0</span>,i);
        compval=operandstr.substring(i+<span class="hljs-number">1</span>)<span class="hljs-number">-0</span>;
        <span class="hljs-keyword">if</span> ((compop == <span class="hljs-string">'&lt;'</span> &amp;&amp; rawvalue &lt; compval) ||
        (compop == <span class="hljs-string">'&lt;='</span> &amp;&amp; rawvalue &lt;= compval) ||
        (compop == <span class="hljs-string">'='</span> &amp;&amp; rawvalue == compval) ||
        (compop == <span class="hljs-string">'&lt;&gt;'</span> &amp;&amp; rawvalue != compval) ||
        (compop == <span class="hljs-string">'&gt;='</span> &amp;&amp; rawvalue &gt;= compval) ||
        (compop == <span class="hljs-string">'&gt;'</span> &amp;&amp; rawvalue &gt; compval)) {
          <span class="hljs-keyword">break</span>;
        }
        gotcomparison = <span class="hljs-number">1</span>;
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>more than one section (separated by “;”)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>two sections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (section == <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (negativevalue) {
        negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// sign will provided by section, not automatically</span>
        section = <span class="hljs-number">1</span>; <span class="hljs-comment">// use second section for negative values</span>
      }
      <span class="hljs-keyword">else</span> {
        section = <span class="hljs-number">0</span>; <span class="hljs-comment">// use first for all others</span>
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>three sections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (section == <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">if</span> (negativevalue) {
        negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// sign will provided by section, not automatically</span>
        section = <span class="hljs-number">1</span>; <span class="hljs-comment">// use second section for negative values</span>
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (zerovalue) {
        section = <span class="hljs-number">2</span>; <span class="hljs-comment">// use third section for zero values</span>
      }
      <span class="hljs-keyword">else</span> {
        section = <span class="hljs-number">0</span>; <span class="hljs-comment">// use first for positive</span>
      }
    }
  }

  sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// look at values for our section</span>

  <span class="hljs-keyword">if</span> (sectioninfo.commas &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// scale by thousands</span>
    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;sectioninfo.commas; i++) {
      value /= <span class="hljs-number">1000</span>;
    }
  }
  <span class="hljs-keyword">if</span> (sectioninfo.percent &gt; <span class="hljs-number">0</span>) { <span class="hljs-comment">// do percent scaling</span>
    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;sectioninfo.percent; i++) {
      value *= <span class="hljs-number">100</span>;
    }
  }

  decimalscale = <span class="hljs-number">1</span>; <span class="hljs-comment">// cut down to required number of decimal digits</span>
  <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;sectioninfo.fractiondigits; i++) {
    decimalscale *= <span class="hljs-number">10</span>;
  }
  scaledvalue = <span class="hljs-built_in">Math</span>.floor(value * decimalscale + <span class="hljs-number">0.5</span>);
  scaledvalue = scaledvalue / decimalscale;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> scaledvalue != <span class="hljs-string">'number'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'NaN'</span>;
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(scaledvalue)) <span class="hljs-keyword">return</span> <span class="hljs-string">'NaN'</span>;

  strvalue = scaledvalue+<span class="hljs-string">''</span>; <span class="hljs-comment">// convert to string (Number.toFixed doesn't do all we need)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>  strvalue = value.toFixed(sectioninfo.fractiondigits); // cut down to required number of decimal digits
and convert to string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">if</span> (scaledvalue == <span class="hljs-number">0</span> &amp;&amp; (sectioninfo.fractiondigits || sectioninfo.integerdigits)) {
    negativevalue = <span class="hljs-number">0</span>; <span class="hljs-comment">// no "-0" unless using multiple sections or General</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>console.log(rawvalue+’’)</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>converted to scientific notation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (strvalue.indexOf(<span class="hljs-string">'e'</span>)&gt;=<span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> rawvalue+<span class="hljs-string">''</span>; <span class="hljs-comment">// Just return plain converted raw value</span>
  }

  strparts=strvalue.match(<span class="hljs-regexp">/^\+{0,1}(\d*)(?:\.(\d*)){0,1}$/</span>); <span class="hljs-comment">// get integer and fraction parts</span>
  <span class="hljs-keyword">if</span> (!strparts) <span class="hljs-keyword">return</span> <span class="hljs-string">'NaN'</span>; <span class="hljs-comment">// if not a number</span>
  integervalue = strparts[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">if</span> (!integervalue || integervalue==<span class="hljs-string">'0'</span>) integervalue=<span class="hljs-string">''</span>;
  fractionvalue = strparts[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">if</span> (!fractionvalue) fractionvalue = <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>there are date placeholders</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (sectioninfo.hasdate) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>console.log(‘hasdate’)
bad date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (rawvalue &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'??-???-?? ??:??:??'</span>;
    }
    startval = (rawvalue-<span class="hljs-built_in">Math</span>.floor(rawvalue)) * SecondsInDay; <span class="hljs-comment">// get date/time parts</span>
    estartval = rawvalue * SecondsInDay; <span class="hljs-comment">// do elapsed time version, too</span>
    hrs = <span class="hljs-built_in">Math</span>.floor(startval / SecondsInHour);
    ehrs = <span class="hljs-built_in">Math</span>.floor(estartval / SecondsInHour);
    startval = startval - hrs * SecondsInHour;
    mins = <span class="hljs-built_in">Math</span>.floor(startval / <span class="hljs-number">60</span>);
    emins = <span class="hljs-built_in">Math</span>.floor(estartval / <span class="hljs-number">60</span>);
    secs = startval - mins * <span class="hljs-number">60</span>;
    decimalscale = <span class="hljs-number">1</span>; <span class="hljs-comment">// round appropriately depending if there is ss.0</span>
    <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;sectioninfo.fractiondigits; i++) {
      decimalscale *= <span class="hljs-number">10</span>;
    }
    secs = <span class="hljs-built_in">Math</span>.floor(secs * decimalscale + <span class="hljs-number">0.5</span>);
    secs = secs / decimalscale;
    esecs = <span class="hljs-built_in">Math</span>.floor(estartval * decimalscale + <span class="hljs-number">0.5</span>);
    esecs = esecs / decimalscale;
    <span class="hljs-keyword">if</span> (secs &gt;= <span class="hljs-number">60</span>) { <span class="hljs-comment">// handle round up into next second, minute, etc.</span>
      secs = <span class="hljs-number">0</span>;
      mins++; emins++;
      <span class="hljs-keyword">if</span> (mins &gt;= <span class="hljs-number">60</span>) {
        mins = <span class="hljs-number">0</span>;
        hrs++; ehrs++;
        <span class="hljs-keyword">if</span> (hrs &gt;= <span class="hljs-number">24</span>) {
          hrs = <span class="hljs-number">0</span>;
          rawvalue++;
        }
      }
    }
    fractionvalue = (secs-<span class="hljs-built_in">Math</span>.floor(secs))+<span class="hljs-string">''</span>; <span class="hljs-comment">// for "hh:mm:ss.000"</span>
    fractionvalue = fractionvalue.substring(<span class="hljs-number">2</span>); <span class="hljs-comment">// skip "0."</span>

    ymd = parsedate(rawvalue);
    ymd = {
      year: ymd.getFullYear(),
      month: ymd.getMonth() + <span class="hljs-number">1</span>,
      day: ymd.getDate()
    }

    minOK = <span class="hljs-number">0</span>; <span class="hljs-comment">// says "m" can be minutes if true</span>
    mspos = sectioninfo.sectionstart; <span class="hljs-comment">// m scan position in ops</span>
    <span class="hljs-keyword">for</span> ( ; ; mspos++) { <span class="hljs-comment">// scan for "m" and "mm" to see if any minutes fields, and am/pm</span>
      op = format.operators[mspos];
      operandstr = format.operands[mspos]; <span class="hljs-comment">// get next operator and operand</span>
      <span class="hljs-keyword">if</span> (!op) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// don't go past end</span>
      <span class="hljs-keyword">if</span> (op==scfn.commands.section) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">if</span> (op==scfn.commands.date) {
        <span class="hljs-keyword">if</span> ((operandstr.toLowerCase()==<span class="hljs-string">'am/pm'</span> || operandstr.toLowerCase()==<span class="hljs-string">'a/p'</span>) &amp;&amp; !ampmstr) {
          <span class="hljs-keyword">if</span> (hrs &gt;= <span class="hljs-number">12</span>) {
            hrs -= <span class="hljs-number">12</span>;
            ampmstr = operandstr.toLowerCase()==<span class="hljs-string">'a/p'</span> ? PM1 : PM; <span class="hljs-comment">// "P" : "PM";</span>
          }
          <span class="hljs-keyword">else</span> {
            ampmstr = operandstr.toLowerCase()==<span class="hljs-string">'a/p'</span> ? AM1 : AM; <span class="hljs-comment">// "A" : "AM";</span>
          }
          <span class="hljs-keyword">if</span> (operandstr.indexOf(ampmstr)&lt;<span class="hljs-number">0</span>)
          ampmstr = ampmstr.toLowerCase(); <span class="hljs-comment">// have case match case in format</span>
        }
        <span class="hljs-keyword">if</span> (minOK &amp;&amp; (operandstr==<span class="hljs-string">'m'</span> || operandstr==<span class="hljs-string">'mm'</span>)) {
          format.operands[mspos] += <span class="hljs-string">'in'</span>; <span class="hljs-comment">// turn into "min" or "mmin"</span>
        }
        <span class="hljs-keyword">if</span> (operandstr.charAt(<span class="hljs-number">0</span>)==<span class="hljs-string">'h'</span>) {
          minOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// m following h or hh or [h] is minutes not months</span>
        }
        <span class="hljs-keyword">else</span> {
          minOK = <span class="hljs-number">0</span>;
        }
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op!=scfn.commands.copy) { <span class="hljs-comment">// copying chars can be between h and m</span>
        minOK = <span class="hljs-number">0</span>;
      }
    }
    minOK = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (--mspos; ; mspos--) { <span class="hljs-comment">// scan other way for s after m</span>
      op = format.operators[mspos];
      operandstr = format.operands[mspos]; <span class="hljs-comment">// get next operator and operand</span>
      <span class="hljs-keyword">if</span> (!op) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// don't go past end</span>
      <span class="hljs-keyword">if</span> (op==scfn.commands.section) <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">if</span> (op==scfn.commands.date) {
        <span class="hljs-keyword">if</span> (minOK &amp;&amp; (operandstr==<span class="hljs-string">'m'</span> || operandstr==<span class="hljs-string">'mm'</span>)) {
          format.operands[mspos] += <span class="hljs-string">'in'</span>; <span class="hljs-comment">// turn into "min" or "mmin"</span>
        }
        <span class="hljs-keyword">if</span> (operandstr==<span class="hljs-string">'ss'</span>) {
          minOK = <span class="hljs-number">1</span>; <span class="hljs-comment">// m before ss is minutes not months</span>
        }
        <span class="hljs-keyword">else</span> {
          minOK = <span class="hljs-number">0</span>;
        }
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op!=scfn.commands.copy) { <span class="hljs-comment">// copying chars can be between ss and m</span>
        minOK = <span class="hljs-number">0</span>;
      }
    }
  }

  integerdigits2 = <span class="hljs-number">0</span>; <span class="hljs-comment">// init counters, etc.</span>
  integerpos = <span class="hljs-number">0</span>;
  fractionpos = <span class="hljs-number">0</span>;
  textcolor = <span class="hljs-string">''</span>;
  textstyle = <span class="hljs-string">''</span>;
  separatorchar = SeparatorChar;
  <span class="hljs-keyword">if</span> (separatorchar.indexOf(<span class="hljs-string">' '</span>)&gt;=<span class="hljs-number">0</span>) separatorchar = separatorchar.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">' '</span>);
  decimalchar = DecimalChar;
  <span class="hljs-keyword">if</span> (decimalchar.indexOf(<span class="hljs-string">' '</span>)&gt;=<span class="hljs-number">0</span>) decimalchar = decimalchar.replace(<span class="hljs-regexp">/ /g</span>, <span class="hljs-string">' '</span>);

  oppos = sectioninfo.sectionstart;

  <span class="hljs-keyword">while</span> (op = format.operators[oppos]) { <span class="hljs-comment">// execute format</span>
    operandstr = format.operands[oppos++]; <span class="hljs-comment">// get next operator and operand</span>

    <span class="hljs-keyword">if</span> (op == scfn.commands.copy) { <span class="hljs-comment">// put char in result</span>
      result += operandstr;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.color) { <span class="hljs-comment">// set color</span>
      textcolor = operandstr;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.style) { <span class="hljs-comment">// set style</span>
      textstyle = operandstr;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.integer_placeholder) { <span class="hljs-comment">// insert number part</span>
      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">'-'</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      integerdigits2++;
      <span class="hljs-keyword">if</span> (integerdigits2 == <span class="hljs-number">1</span>) { <span class="hljs-comment">// first one</span>
        <span class="hljs-keyword">if</span> (integervalue.length &gt; sectioninfo.integerdigits) { <span class="hljs-comment">// see if integer wider than field</span>
          <span class="hljs-keyword">for</span> (;integerpos &lt; (integervalue.length - sectioninfo.integerdigits); integerpos++) {
            result += integervalue.charAt(integerpos);
            <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) { <span class="hljs-comment">// see if this is a separator position</span>
              fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
              <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
                result += separatorchar;
              }
            }
          }
        }
      }
      <span class="hljs-keyword">if</span> (integervalue.length &lt; sectioninfo.integerdigits
        &amp;&amp; integerdigits2 &lt;= sectioninfo.integerdigits - integervalue.length) { <span class="hljs-comment">// field is wider than value</span>
          <span class="hljs-keyword">if</span> (operandstr == <span class="hljs-string">'0'</span> || operandstr == <span class="hljs-string">'?'</span>) { <span class="hljs-comment">// fill with appropriate characters</span>
          result += operandstr == <span class="hljs-string">'0'</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">' '</span>;
          <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) { <span class="hljs-comment">// see if this is a separator position</span>
            fromend = sectioninfo.integerdigits - integerdigits2;
            <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
              result += separatorchar;
            }
          }
        }
      }
      <span class="hljs-keyword">else</span> { <span class="hljs-comment">// normal integer digit - add it</span>
        result += integervalue.charAt(integerpos);
        <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) { <span class="hljs-comment">// see if this is a separator position</span>
          fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
            result += separatorchar;
          }
        }
        integerpos++;
      }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.fraction_placeholder) { <span class="hljs-comment">// add fraction part of number</span>
      <span class="hljs-keyword">if</span> (fractionpos &gt;= fractionvalue.length) {
        <span class="hljs-keyword">if</span> (operandstr == <span class="hljs-string">'0'</span> || operandstr == <span class="hljs-string">'?'</span>) {
          result += operandstr == <span class="hljs-string">'0'</span> ? <span class="hljs-string">'0'</span> : <span class="hljs-string">' '</span>;
        }
      }
      <span class="hljs-keyword">else</span> {
        result += fractionvalue.charAt(fractionpos);
      }
      fractionpos++;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.decimal) { <span class="hljs-comment">// decimal point</span>
      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">'-'</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      result += decimalchar;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.currency) { <span class="hljs-comment">// currency symbol</span>
      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">'-'</span>;
        negativevalue = <span class="hljs-number">0</span>;
      }
      result += operandstr;
    }

    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.general) { <span class="hljs-comment">// insert "General" conversion</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><em>*</em> Cut down number of significant digits to avoid floating point artifacts:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
      <span class="hljs-keyword">if</span> (value!=<span class="hljs-number">0</span>) { <span class="hljs-comment">// only if non-zero</span>
        <span class="hljs-keyword">var</span> factor = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.LOG10E * <span class="hljs-built_in">Math</span>.log(value)); <span class="hljs-comment">// get integer magnitude as a power of 10</span>
        factor = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">10</span>, <span class="hljs-number">13</span>-factor); <span class="hljs-comment">// turn into scaling factor</span>
        value = <span class="hljs-built_in">Math</span>.floor(factor * value + <span class="hljs-number">0.5</span>)/factor; <span class="hljs-comment">// scale positive value, round, undo scaling</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFinite</span>(value)) <span class="hljs-keyword">return</span> <span class="hljs-string">'NaN'</span>;
      }
      <span class="hljs-keyword">if</span> (negativevalue) {
        result += <span class="hljs-string">'-'</span>;
      }
      strvalue = value+<span class="hljs-string">''</span>; <span class="hljs-comment">// convert original value to string</span>
      <span class="hljs-keyword">if</span> (strvalue.indexOf(<span class="hljs-string">'e'</span>)&gt;=<span class="hljs-number">0</span>) { <span class="hljs-comment">// converted to scientific notation</span>
      result += strvalue;
      <span class="hljs-keyword">continue</span>;
    }
    strparts=strvalue.match(<span class="hljs-regexp">/^\+{0,1}(\d*)(?:\.(\d*)){0,1}$/</span>); <span class="hljs-comment">// get integer and fraction parts</span>
    integervalue = strparts[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">if</span> (!integervalue || integervalue==<span class="hljs-string">'0'</span>) integervalue=<span class="hljs-string">''</span>;
    fractionvalue = strparts[<span class="hljs-number">2</span>];
    <span class="hljs-keyword">if</span> (!fractionvalue) fractionvalue = <span class="hljs-string">''</span>;
    integerpos = <span class="hljs-number">0</span>;
    fractionpos = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (integervalue.length) {
      <span class="hljs-keyword">for</span> (;integerpos &lt; integervalue.length; integerpos++) {
        result += integervalue.charAt(integerpos);
        <span class="hljs-keyword">if</span> (sectioninfo.thousandssep) { <span class="hljs-comment">// see if this is a separator position</span>
          fromend = integervalue.length - integerpos - <span class="hljs-number">1</span>;
          <span class="hljs-keyword">if</span> (fromend &gt; <span class="hljs-number">2</span> &amp;&amp; fromend % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>) {
            result += separatorchar;
          }
        }
      }
    }
    <span class="hljs-keyword">else</span> {
      result += <span class="hljs-string">'0'</span>;
    }
    <span class="hljs-keyword">if</span> (fractionvalue.length) {
      result += decimalchar;
      <span class="hljs-keyword">for</span> (;fractionpos &lt; fractionvalue.length; fractionpos++) {
        result += fractionvalue.charAt(fractionpos);
      }
    }
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op==scfn.commands.date) { <span class="hljs-comment">// date placeholder</span>
    operandstrlc = operandstr.toLowerCase();
    <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'y'</span> || operandstrlc==<span class="hljs-string">'yy'</span>) {
      result += (ymd.year+<span class="hljs-string">''</span>).substring(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'yyyy'</span>) {
      result += ymd.year+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'d'</span>) {
      result += ymd.day+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'dd'</span>) {
      cval = <span class="hljs-number">1000</span> + ymd.day;
      result += (cval+<span class="hljs-string">''</span>).substr(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'ddd'</span>) {
      cval = <span class="hljs-built_in">Math</span>.floor(rawvalue+<span class="hljs-number">6</span>) % <span class="hljs-number">7</span>;
      result += DayNames3[cval];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'dddd'</span>) {
      cval = <span class="hljs-built_in">Math</span>.floor(rawvalue+<span class="hljs-number">6</span>) % <span class="hljs-number">7</span>;
      result += DayNames[cval];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'m'</span>) {
      result += ymd.month+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mm'</span>) {
      cval = <span class="hljs-number">1000</span> + ymd.month;
      result += (cval+<span class="hljs-string">''</span>).substr(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mmm'</span>) {
      result += MonthNames3[ymd.month<span class="hljs-number">-1</span>];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mmmm'</span>) {
      result += MonthNames[ymd.month<span class="hljs-number">-1</span>];
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mmmmm'</span>) {
      result += MonthNames[ymd.month<span class="hljs-number">-1</span>].charAt(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'h'</span>) {
      result += hrs+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'h]'</span>) {
      result += ehrs+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mmin'</span>) {
      cval = (<span class="hljs-number">1000</span> + mins)+<span class="hljs-string">''</span>;
      result += cval.substr(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'mm]'</span>) {
      <span class="hljs-keyword">if</span> (emins &lt; <span class="hljs-number">100</span>) {
        cval = (<span class="hljs-number">1000</span> + emins)+<span class="hljs-string">''</span>;
        result += cval.substr(<span class="hljs-number">2</span>);
      }
      <span class="hljs-keyword">else</span> {
        result += emins+<span class="hljs-string">''</span>;
      }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'min'</span>) {
      result += mins+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'m]'</span>) {
      result += emins+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'hh'</span>) {
      cval = (<span class="hljs-number">1000</span> + hrs)+<span class="hljs-string">''</span>;
      result += cval.substr(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'s'</span>) {
      cval = <span class="hljs-built_in">Math</span>.floor(secs);
      result += cval+<span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'ss'</span>) {
      cval = (<span class="hljs-number">1000</span> + <span class="hljs-built_in">Math</span>.floor(secs))+<span class="hljs-string">''</span>;
      result += cval.substr(<span class="hljs-number">2</span>);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'am/pm'</span> || operandstrlc==<span class="hljs-string">'a/p'</span>) {
      result += ampmstr;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (operandstrlc==<span class="hljs-string">'ss]'</span>) {
      <span class="hljs-keyword">if</span> (esecs &lt; <span class="hljs-number">100</span>) {
        cval = (<span class="hljs-number">1000</span> + <span class="hljs-built_in">Math</span>.floor(esecs))+<span class="hljs-string">''</span>;
        result += cval.substr(<span class="hljs-number">2</span>);
      }
      <span class="hljs-keyword">else</span> {
        cval = <span class="hljs-built_in">Math</span>.floor(esecs);
        result += cval+<span class="hljs-string">''</span>;
      }
    }
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.section) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>end of section</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (op == scfn.commands.comparison) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>ignore</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">continue</span>;
  }

  <span class="hljs-keyword">else</span> {
    result += <span class="hljs-string">'!! Parse error.!!'</span>;
  }
}

<span class="hljs-keyword">if</span> (textcolor) {
  result = <span class="hljs-string">'&lt;span style="color:'</span>+textcolor+<span class="hljs-string">';"&gt;'</span>+result+<span class="hljs-string">'&lt;/span&gt;'</span>;
}
<span class="hljs-keyword">if</span> (textstyle) {
  result = <span class="hljs-string">'&lt;span style="'</span>+textstyle+<span class="hljs-string">';"&gt;'</span>+result+<span class="hljs-string">'&lt;/span&gt;'</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>console.log(result)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">return</span> result;

};

<span class="hljs-comment">/* *******************

FormatNumber.parse_format_string(format_defs, format_string)

Takes a format string (e.g., "#,##0.00_);(#,##0.00)") and fills in format_defs with the parsed info

format_defs
["#,##0.0"]-&gt;{} - elements in the hash are one hash for each format
.operators-&gt;[] - array of operators from parsing the format string (each a number)
.operands-&gt;[] - array of corresponding operators (each usually a string)
.sectioninfo-&gt;[] - one hash for each section of the format
.start
.integerdigits
.fractiondigits
.commas
.percent
.thousandssep
.hasdates
.hascomparison - true if any section has [&lt;100], etc.

************************* */</span>

FormatNumber.parse_format_string = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">format_defs, format_string</span>) </span>{

  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> format, section, sectioninfo;
  <span class="hljs-keyword">var</span> integerpart = <span class="hljs-number">1</span>; <span class="hljs-comment">// start out in integer part</span>
  <span class="hljs-keyword">var</span> lastwasinteger; <span class="hljs-comment">// last char was an integer placeholder</span>
  <span class="hljs-keyword">var</span> lastwasslash; <span class="hljs-comment">// last char was a backslash - escaping following character</span>
  <span class="hljs-keyword">var</span> lastwasasterisk; <span class="hljs-comment">// repeat next char</span>
  <span class="hljs-keyword">var</span> lastwasunderscore; <span class="hljs-comment">// last char was _ which picks up following char for width</span>
  <span class="hljs-keyword">var</span> inquote, quotestr; <span class="hljs-comment">// processing a quoted string</span>
  <span class="hljs-keyword">var</span> inbracket, bracketstr, bracketdata; <span class="hljs-comment">// processing a bracketed string</span>
  <span class="hljs-keyword">var</span> ingeneral, gpos; <span class="hljs-comment">// checks for characters "General"</span>
  <span class="hljs-keyword">var</span> ampmstr, part; <span class="hljs-comment">// checks for characters "A/P" and "AM/PM"</span>
  <span class="hljs-keyword">var</span> indate; <span class="hljs-comment">// keeps track of date/time placeholders</span>
  <span class="hljs-keyword">var</span> chpos; <span class="hljs-comment">// character position being looked at</span>
  <span class="hljs-keyword">var</span> ch; <span class="hljs-comment">// character being looked at</span>

  <span class="hljs-keyword">if</span> (format_defs[format_string]) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// already defined - nothing to do</span>

  format = {operators: [], operands: [], sectioninfo: [{}]}; <span class="hljs-comment">// create info structure for this format</span>
  format_defs[format_string] = format; <span class="hljs-comment">// add to other format definitions</span>

  section = <span class="hljs-number">0</span>; <span class="hljs-comment">// start with section 0</span>
  sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// get reference to info for current section</span>
  sectioninfo.sectionstart = <span class="hljs-number">0</span>; <span class="hljs-comment">// position in operands that starts this section</span>
  sectioninfo.integerdigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// number of integer-part placeholders</span>
  sectioninfo.fractiondigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// fraction placeholders</span>
  sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// commas encountered, to handle scaling</span>
  sectioninfo.percent = <span class="hljs-number">0</span>; <span class="hljs-comment">// times to scale by 100</span>

  <span class="hljs-keyword">for</span> (chpos=<span class="hljs-number">0</span>; chpos&lt;format_string.length; chpos++) { <span class="hljs-comment">// parse</span>
    ch = format_string.charAt(chpos); <span class="hljs-comment">// get next char to examine</span>
    <span class="hljs-keyword">if</span> (inquote) {
      <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">'"'</span>) {
        inquote = <span class="hljs-number">0</span>;
        format.operators.push(scfn.commands.copy);
        format.operands.push(quotestr);
        <span class="hljs-keyword">continue</span>;
      }
      quotestr += ch;
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (inbracket) {
      <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">']'</span>) {
        inbracket = <span class="hljs-number">0</span>;
        bracketdata=FormatNumber.parse_format_bracket(bracketstr);
        <span class="hljs-keyword">if</span> (bracketdata.operator==scfn.commands.separator) {
          sectioninfo.thousandssep = <span class="hljs-number">1</span>; <span class="hljs-comment">// explicit [,]</span>
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (bracketdata.operator==scfn.commands.date) {
          sectioninfo.hasdate = <span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">if</span> (bracketdata.operator==scfn.commands.comparison) {
          format.hascomparison = <span class="hljs-number">1</span>;
        }
        format.operators.push(bracketdata.operator);
        format.operands.push(bracketdata.operand);
        <span class="hljs-keyword">continue</span>;
      }
      bracketstr += ch;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasslash) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch);
      lastwasslash=<span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasasterisk) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch+ch+ch+ch+ch); <span class="hljs-comment">// do 5 of them since no real tabs</span>
      lastwasasterisk=<span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (lastwasunderscore) {
      format.operators.push(scfn.commands.copy);
      format.operands.push(<span class="hljs-string">' '</span>);
      lastwasunderscore=<span class="hljs-literal">false</span>;
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-keyword">if</span> (ingeneral) {
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'general'</span>.charAt(ingeneral)==ch.toLowerCase()) {
        ingeneral++;
        <span class="hljs-keyword">if</span> (ingeneral == <span class="hljs-number">7</span>) {
          format.operators.push(scfn.commands.general);
          format.operands.push(ch);
          ingeneral=<span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">continue</span>;
      }
      ingeneral = <span class="hljs-number">0</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>last char was part of a date placeholder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (indate) {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>console.log(‘foo’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (indate.charAt(<span class="hljs-number">0</span>)==ch) { <span class="hljs-comment">// another of the same char</span>
        indate += ch; <span class="hljs-comment">// accumulate it</span>
        <span class="hljs-keyword">continue</span>;
      }
      format.operators.push(scfn.commands.date); <span class="hljs-comment">// something else, save date info</span>
      format.operands.push(indate);
      sectioninfo.hasdate=<span class="hljs-number">1</span>;
      indate = <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">if</span> (ampmstr) {
      ampmstr += ch;
      part=ampmstr.toLowerCase();
      <span class="hljs-keyword">if</span> (part!=<span class="hljs-string">'am/pm'</span>.substring(<span class="hljs-number">0</span>,part.length) &amp;&amp; part!=<span class="hljs-string">'a/p'</span>.substring(<span class="hljs-number">0</span>,part.length)) {
        ampstr=<span class="hljs-string">''</span>;
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (part==<span class="hljs-string">'am/pm'</span> || part==<span class="hljs-string">'a/p'</span>) {
        format.operators.push(scfn.commands.date);
        format.operands.push(ampmstr);
        ampmstr = <span class="hljs-string">''</span>;
      }
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'#'</span> || ch==<span class="hljs-string">'0'</span> || ch==<span class="hljs-string">'?'</span>) { <span class="hljs-comment">// placeholder</span>
    <span class="hljs-keyword">if</span> (integerpart) {
      sectioninfo.integerdigits++;
      <span class="hljs-keyword">if</span> (sectioninfo.commas) { <span class="hljs-comment">// comma inside of integer placeholders</span>
        sectioninfo.thousandssep = <span class="hljs-number">1</span>; <span class="hljs-comment">// any number is thousands separator</span>
        sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// reset count of "thousand" factors</span>
      }
      lastwasinteger = <span class="hljs-number">1</span>;
      format.operators.push(scfn.commands.integer_placeholder);
      format.operands.push(ch);
    }
    <span class="hljs-keyword">else</span> {
      sectioninfo.fractiondigits++;
      format.operators.push(scfn.commands.fraction_placeholder);
      format.operands.push(ch);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch == <span class="hljs-string">'.'</span>) {
    lastwasinteger = <span class="hljs-number">0</span>;
    format.operators.push(scfn.commands.decimal);
    format.operands.push(ch);
    integerpart = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch === <span class="hljs-string">'$'</span>) {
    lastwasinteger = <span class="hljs-number">0</span>;
    format.operators.push(scfn.commands.currency);
    format.operands.push(ch);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">','</span>) {
    <span class="hljs-keyword">if</span> (lastwasinteger) {
      sectioninfo.commas++;
    } <span class="hljs-keyword">else</span> {
      format.operators.push(scfn.commands.copy);
      format.operands.push(ch);
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'%'</span>) {
    lastwasinteger = <span class="hljs-number">0</span>;
    sectioninfo.percent++;
    format.operators.push(scfn.commands.copy);
    format.operands.push(ch);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'"'</span>) {
    lastwasinteger = <span class="hljs-number">0</span>;
    inquote = <span class="hljs-number">1</span>;
    quotestr = <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'['</span>) {
    lastwasinteger = <span class="hljs-number">0</span>;
    inbracket = <span class="hljs-number">1</span>;
    bracketstr = <span class="hljs-string">''</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'\\'</span>) {
    lastwasslash = <span class="hljs-number">1</span>;
    lastwasinteger = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'*'</span>) {
    lastwasasterisk = <span class="hljs-number">1</span>;
    lastwasinteger = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">'_'</span>) {
    lastwasunderscore = <span class="hljs-number">1</span>;
    lastwasinteger = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch==<span class="hljs-string">';'</span>) {
    section++; <span class="hljs-comment">// start next section</span>
    format.sectioninfo[section] = {}; <span class="hljs-comment">// create a new section</span>
    sectioninfo = format.sectioninfo[section]; <span class="hljs-comment">// get reference to info for current section</span>
    sectioninfo.sectionstart = <span class="hljs-number">1</span> + format.operators.length; <span class="hljs-comment">// remember where it starts</span>
    sectioninfo.integerdigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// number of integer-part placeholders</span>
    sectioninfo.fractiondigits = <span class="hljs-number">0</span>; <span class="hljs-comment">// fraction placeholders</span>
    sectioninfo.commas = <span class="hljs-number">0</span>; <span class="hljs-comment">// commas encountered, to handle scaling</span>
    sectioninfo.percent = <span class="hljs-number">0</span>; <span class="hljs-comment">// times to scale by 100</span>
    integerpart = <span class="hljs-number">1</span>; <span class="hljs-comment">// reset for new section</span>
    lastwasinteger = <span class="hljs-number">0</span>;
    format.operators.push(scfn.commands.section);
    format.operands.push(ch);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch.toLowerCase()==<span class="hljs-string">'g'</span>) {
    ingeneral = <span class="hljs-number">1</span>;
    lastwasinteger = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ch.toLowerCase()==<span class="hljs-string">'a'</span>) {
    ampmstr = ch;
    lastwasinteger = <span class="hljs-number">0</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">'dmyhHs'</span>.indexOf(ch)&gt;=<span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>console.log(‘foo’)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    indate = ch;
  } <span class="hljs-keyword">else</span> {
    lastwasinteger = <span class="hljs-number">0</span>;
    format.operators.push(scfn.commands.copy);
    format.operands.push(ch);
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>last char was part of unsaved date placeholder</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (indate) {
  format.operators.push(scfn.commands.date);
  format.operands.push(indate);
  sectioninfo.hasdate = <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">return</span>;

}


<span class="hljs-comment">/* *******************

bracketdata = FormatNumber.parse_format_bracket(bracketstr)

Takes a bracket contents (e.g., "RED", "&gt;10") and returns an operator and operand

bracketdata-&gt;{}
.operator
.operand

************************* */</span>

FormatNumber.parse_format_bracket = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">bracketstr</span>) </span>{

  <span class="hljs-keyword">var</span> scfn = FormatNumber;

  <span class="hljs-keyword">var</span> bracketdata={};
  <span class="hljs-keyword">var</span> parts;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>currency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (bracketstr.charAt(<span class="hljs-number">0</span>)==<span class="hljs-string">'$'</span>) {
    bracketdata.operator = scfn.commands.currency;
    parts=bracketstr.match(<span class="hljs-regexp">/^\$(.+?)(\-.+?){0,1}$/</span>);
    <span class="hljs-keyword">if</span> (parts) {
      bracketdata.operand = parts[<span class="hljs-number">1</span>] || DefaultCurrency || <span class="hljs-string">'$'</span>;
    } <span class="hljs-keyword">else</span> {
      bracketdata.operand = bracketstr.substring(<span class="hljs-number">1</span>) || DefaultCurrency || <span class="hljs-string">'$'</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bracketstr==<span class="hljs-string">'?$'</span>) {
    bracketdata.operator = scfn.commands.currency;
    bracketdata.operand = <span class="hljs-string">'[?$]'</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (AllowedColors[bracketstr.toUpperCase()]) {
    bracketdata.operator = scfn.commands.color;
    bracketdata.operand = AllowedColors[bracketstr.toUpperCase()];
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parts=bracketstr.match(<span class="hljs-regexp">/^style=([^']*)$/</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>[style=…]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    bracketdata.operator = scfn.commands.style;
    bracketdata.operand = parts[<span class="hljs-number">1</span>];
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bracketstr==<span class="hljs-string">','</span>) {
    bracketdata.operator = scfn.commands.separator;
    bracketdata.operand = bracketstr;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (AllowedDates[bracketstr.toUpperCase()]) {
    bracketdata.operator = scfn.commands.date;
    bracketdata.operand = AllowedDates[bracketstr.toUpperCase()];
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parts=bracketstr.match(<span class="hljs-regexp">/^[&lt;&gt;=]/</span>)) { <span class="hljs-comment">// comparison operator</span>
    parts=bracketstr.match(<span class="hljs-regexp">/^([&lt;&gt;=]+)(.+)$/</span>); <span class="hljs-comment">// split operator and value</span>
    bracketdata.operator = scfn.commands.comparison;
    bracketdata.operand = parts[<span class="hljs-number">1</span>]+<span class="hljs-string">':'</span>+parts[<span class="hljs-number">2</span>];
  }
  <span class="hljs-keyword">else</span> { <span class="hljs-comment">// unknown bracket</span>
    bracketdata.operator = scfn.commands.copy;
    bracketdata.operand = <span class="hljs-string">'['</span>+bracketstr+<span class="hljs-string">']'</span>;
  }

  <span class="hljs-keyword">return</span> bracketdata;

}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">text</span>(<span class="hljs-params">value, format, currency_char</span>) </span>{
  <span class="hljs-keyword">return</span> FormatNumber.formatNumberWithFormat(value, format, currency_char);
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
